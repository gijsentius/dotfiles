#!/bin/zsh

# Always install homebrew
brew_install_script="$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
bash -c "${brew_install_script}"

{{ if eq .chezmoi.os "linux" -}}

sudo apt update
sudo apt upgrade -y

sudo apt install ripgrep
sudo apt install wget
sudo apt install build-essential
sudo apt install kubectl
sudo apt install git-extras
sudo apt install tmux
sudo apt install zsh
sudo apt install git
sudo apt install make
sudo apt install unzip
sudo apt install fd-find
sudo apt install xclip


curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
curl -s https://fluxcd.io/install.sh | sudo bash
curl -LsSf https://astral.sh/ruff/install.sh | sh
curl -sS https://starship.rs/install.sh | sh -s -- --yes
curl -sS https://webinstall.dev/k9s | bash

git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
~/.fzf/install

if [ ! -d "${XDG_CONFIG_HOME:-$HOME/.tmux}" ]; then
  git clone https://github.com/gpakosz/.tmux.git ~/.tmux
  ln -s -f ~/.tmux/.tmux.conf
  cp ~/.tmux/.tmux.conf.local .
fi

curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
sudo rm -rf /opt/nvim-linux-x86_64
sudo tar -C /opt -xzf nvim-linux-x86_64.tar.gz


sudo apt autoremove -y

{{ else if eq .chezmoi.os "darwin" -}}

# Save Homebrew’s installed location.
BREW_PREFIX=$(brew --prefix)

# Install GNU core utilities (those that come with macOS are outdated).
# Don’t forget to add `$(brew --prefix coreutils)/libexec/gnubin` to `$PATH`.
brew install coreutils
ln -s "${BREW_PREFIX}/bin/gsha256sum" "${BREW_PREFIX}/bin/sha256sum"

# Install some other useful utilities like `sponge`.
brew install moreutils
# Install GNU `find`, `locate`, `updatedb`, and `xargs`, `g`-prefixed.
brew install findutils
# Install GNU `sed`, overwriting the built-in `sed`.
brew install gnu-sed --with-default-names

# Install quick search tools
brew install ripgrep
brew install fd

# Install various tools needed for development
brew install starship
brew install zsh-syntax-highlighting
brew install k9s
brew install trivy
brew install elixir
brew install tmux
brew install npm
brew install ruff
brew install neovim
brew install lima
brew install go
brew install font-fira-code-nerd-font
brew install --cask font-cascadia-code-pl
brew install --cask alacritty
brew install fluxcd/tap/flux
brew install mergiraf
brew install difftastic
npm install -g @anthropic-ai/claude-code

# Install other useful binaries.
brew install ack
#brew install exiv2
brew install git
brew install make
brew install unzip
brew install fzf
brew install git-lfs
brew install gs
brew install wget
brew install imagemagick --with-webp
brew install lua
brew install lynx
brew install p7zip
brew install pigz
brew install pv
brew install rename
brew install xclip
brew install rlwrap
brew install ssh-copy-id
brew install tree
brew install vbindiff
brew install zopfli

# Install some CTF tools
brew install aircrack-ng
brew install bfg
brew install binutils
brew install binwalk
brew install cifer
brew install dex2jar
brew install dns2tcp
brew install fcrackzip
brew install foremost
brew install hashpump
brew install hydra
brew install john
brew install knock
brew install netpbm
brew install nmap
brew install pngcheck
brew install socat
brew install sqlmap
brew install tcpflow
brew install tcpreplay
brew install tcptrace
brew install ucspi-tcp # `tcpserver` etc
brew install xpdf
brew install xz

# Remove outdated versions from the cellar.
brew cleanup

{{ end -}}

curl -fsSL https://claude.ai/install.sh | bash
brew install gemini-cli

(
  set -x; cd "$(mktemp -d)" &&
  OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
  ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
  KREW="krew-${OS}_${ARCH}" &&
  curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
  tar zxvf "${KREW}.tar.gz" &&
  ./"${KREW}" install krew
)
